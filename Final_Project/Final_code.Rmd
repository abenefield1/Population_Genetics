---
title: "Final Population Genetics Project"
author: "Amy Benefield"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
    github_document:
        pandoc_args: --webtex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Libraries:
``` {r message=FALSE}
library("adegenet")
library("hierfstat")
library("pegas")
```

# Data Cleaning and Exploratory Data Analysis

#### Reading in Data:
```{r}
data<-read.table("Dataset3.genind.txt", sep="", header=TRUE)
head(data[1:10])
loci<-data[,c(-1,-2)]
head(loci[1:10])
str(loci[1:10])
```

#### Labels of the individuals
```{r}
index <- as.character(data$sample)
```

#### Labels of the populations
```{r}
pops <- as.character(data$pop)
```

## Transform from dataframe to genind:
```{r}
data_genind <- df2genind(loci, ploidy = 2, ind.names = index, 
                          pop = pops, sep = "/") 

data_genind
```

## Hardy_Weinberg Tests and P-Values:
```{r}
hw<-hw.test(data_genind, B=0)
pvals<-hw[,3]
num_loci<-subset(pvals,pvals<0.05)
print("Number of loci outside of HWE:") 
length(num_loci)
```
MCMC Permutation:
```{r}
#HW<-hw.test(data_genind, B = 1000)
#PVALS<-HW[,4]
#NUM_loci<-subset(PVALS,PVALS<0.05)
#print("Number of loci outside of HWE:") 
#length(NUM_loci)
```

# Diversity Statistics
  Now that everything is formatted properly we can calculate genetic diversity (observed and expected heterozygosity). First, we'll do this with adegenet:
  Lets create a new object called "DIV" that summarizes the information in our pines_genind object

```{r}
DIV <- summary(data_genind)
names(DIV)## this tells us the names of each slot of the DIV object
DIV$n
DIV$n.by.pop
DIV$loc.n.all[1:10]
DIV$pop.n.all
DIV$NA.perc
DIV$Hobs[1:10]
DIV$Hexp[1:10]
```

### Look at proportion of heterozygosity per locus:
```{r plot, fig.width=4, fig.height=3, message=FALSE}
plot(DIV$Hobs, xlab="Locus ID", ylab="Observed Heterozygosity", 
     main="Observed heterozygosity per locus")
```

### We also want to compare observed and expected heterozygosity
```{r plot1, fig.width=4, fig.height=3, message=FALSE}
plot(DIV$Hobs,DIV$Hexp, xlab="Hobs", ylab="Hexp", 
     main="Hexp Hobs per locus")
lm<-lm(DIV$Hexp~DIV$Hobs)
summary(lm)
abline(lm, col="red", lwd=3)
```

##### Now we can test if there a significant difference between observed and expected heterozygosity:
Check the variances are equal:
```{r}
bartlett.test(list(DIV$Hexp, DIV$Hobs))
```
**VARIANCE ISN'T EQUAL**: p-value < 2.2e-16: Probably need to do some data transformation

```{r}
t.test(DIV$Hexp, DIV$Hobs, paired = T, alternative = "greater", var.equal = TRUE)
```

# Basic Statistics with Hierfstat:
  Now, let's do basic statistics with hierfstat. We need to convert genind object to a hierfstat object, because sometimes analysis in R is dumb and requires lots of reformatting. This format is needed to analyze pairwise FST.
Create hierfstat object where populations are sites:
```{r}
data_hier <- genind2hierfstat(data_genind)
```

  The function basic.stats() provides the observed heterozygosity (Ho), mean gene diversities within population (Hs), Fis, and Fst. The function boot.ppfis() provides confidence interval for Fis. 
Calculate basic stats on dataset:
```{r}
basicstat_final <- basic.stats(data_hier, diploid = TRUE, digits = 2)
# Calling, "basicstat_final" gives a summary of the information contained in the slots (the perloc and overall options), but we won't do that, because it's a large dataset:
# basicstat_final
```

Let's first look at the relationship between sample size and heterozygosity. We're going to use the "apply" function to summarize the data tables in different slots of our basicstat_final object. It creates an object where we the average sample size for each locus in each pop. This is the mean of each column in the basicstat_final$n.ind.samp slot:
```{r}
sample.size<-apply(basicstat_final$n.ind.samp, 2 ,mean) 
```

Average Ho for each locus in each pop. This is the mean of each column in the basicstat_final$Ho slot:
```{r}
ho<-apply(basicstat_final$Ho, 2 ,mean)
```

Now we plot those two values agains each other:
```{r}
plot(sample.size, ho) ## plot Ho against sample size
```

Ok- now let's plot Hs (the average heterozygosity of subdivided pops) against Ht (the pooled heterozygosity). You'll see that these values are columns in the basicstat_final$perloc slot.We can just plot those columns against each other:
```{r}
plot(basicstat_final$perloc$Hs, basicstat_final$perloc$Ht, xlab="Hs in subdivided populations", 
     ylab="Ht in pooled popultions")
```

```{r}
plot(basicstat_final$perloc$Fst)
```

### Fst:
Weir & Cockerham's Fst
```{r}
wc(data_genind)
```

**Pairwise Fst**- this gives us the Fst between each pair of populations using Weir and Cockerham's estimator. This is a measure of genetic distance bewteen each pair of populations. This calculation might take a minute:
```{r}
fst.dist<-genet.dist(data_genind, method = "WC84")
fst.dist
max(fst.dist) ## maximum pairwise fst
min(fst.dist) ## minimum pairwise fst
mean(fst.dist) ## mean fst across all pairs
```

# Pairwise Fst and Isolation by Distance (IBD)
Let's look for evidence of isolation by distance. If you get a message asking to restart R, click "no".

More libraries:
``` {r message=FALSE}
library(geonames)
library(data.table)
library(purrr)
library(geosphere)
```

Create an object that contains the name of each state where sampling was done. This pulls out each unique island from our dataset and puts them in a vector:
```{r}
islands<-sort(unique(data$pop)) 
islands
```



```{r}

```


